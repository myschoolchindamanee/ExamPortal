<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Chindamanee School Exam Portal</title>
  <script src="https://unpkg.com/@supabase/supabase-js"></script>
  <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f8f9fa;
      display: flex;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      padding: 30px;
    }
    .container {
      background: white;
      padding: 25px;
      border-radius: 12px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      width: 500px;
      text-align: center;
    }
    img {
      max-width: 120px;
      margin-bottom: 15px;
    }
    input, select, button {
      width: 100%;
      margin: 8px 0;
      padding: 10px;
      border-radius: 6px;
      border: 1px solid #ddd;
    }
    button {
      background: #007bff;
      color: white;
      border: none;
      cursor: pointer;
    }
    button:hover {
      background: #0056b3;
    }
    #uploads {
      margin-top: 20px;
      text-align: left;
      max-height: 200px;
      overflow-y: auto;
    }
    #uploads ul {
      list-style: none;
      padding: 0;
    }
    #uploads li {
      background: #f1f1f1;
      margin: 5px 0;
      padding: 8px;
      border-radius: 6px;
      font-size: 14px;
    }
    #uploads a {
      float: right;
      text-decoration: none;
      color: #007bff;
    }
  </style>
</head>
<body>

  <div class="container">
    <img src="logo.png" alt="School Logo">
    <h2>Exam Paper Upload</h2>

    <div id="auth-section">
      <input type="email" id="email" placeholder="Enter your school email">
      <input type="password" id="password" placeholder="Enter password">
      <button onclick="signUp()">Sign Up</button>
      <button onclick="signIn()">Sign In</button>
    </div>

    <div id="upload-section" style="display:none;">
      <h3>Upload Exam Paper</h3>
      <select id="year">
        <option value="">Select Year</option>
        <option>Year 7</option>
        <option>Year 8</option>
        <option>Year 9</option>
        <option>Year 10</option>
        <option>Year 11</option>
        <option>Year 12</option>
        <option>Year 13</option>
      </select>
      <input type="text" id="subject" placeholder="Enter subject">
      <input type="file" id="file">
      <button onclick="uploadFile()">Upload</button>
      <button onclick="signOut()">Sign Out</button>

      <!-- My Uploads -->
      <div id="uploads">
        <h4>My Uploads</h4>
        <ul id="upload-list"></ul>
      </div>
    </div>
  </div>

<script>
  // --- Supabase setup ---
  const supabaseUrl = "https://vydaeemptmxxixwwoepj.supabase.co";
  const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ5ZGFlZW1wdG14eGl4d3dvZXBqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc5ODUzMzUsImV4cCI6MjA3MzU2MTMzNX0.46QAkga8WetD8BWNnYq1x-SABBtdv0pbCEtMCuR3x7c";
  const supabase = supabase.createClient(supabaseUrl, supabaseKey);

  // --- EmailJS setup ---
  (function(){
    emailjs.init("YOUR_PUBLIC_KEY"); // Replace with your EmailJS Public Key
  })();

  async function signUp() {
    const email = document.getElementById("email").value;
    const password = document.getElementById("password").value;

    if (!email.endsWith("@chindamanee.ac.th")) {
      alert("Only @chindamanee.ac.th emails are allowed.");
      return;
    }

    let { user, error } = await supabase.auth.signUp({ email, password });
    if (error) {
      alert(error.message);
    } else {
      alert("Sign up successful! Please check your email to confirm.");
    }
  }

  async function signIn() {
    const email = document.getElementById("email").value;
    const password = document.getElementById("password").value;

    let { user, error } = await supabase.auth.signIn({ email, password });
    if (error) {
      alert(error.message);
    } else {
      document.getElementById("auth-section").style.display = "none";
      document.getElementById("upload-section").style.display = "block";
      loadMyUploads(); // Load uploads when signed in
    }
  }

  async function signOut() {
    await supabase.auth.signOut();
    document.getElementById("upload-section").style.display = "none";
    document.getElementById("auth-section").style.display = "block";
  }

  async function uploadFile() {
    const file = document.getElementById("file").files[0];
    const subject = document.getElementById("subject").value;
    const year = document.getElementById("year").value;

    if (!file || !subject || !year) {
      alert("Please select class, enter subject, and choose a file.");
      return;
    }

    const user = supabase.auth.user();
    const filePath = `${year}/${subject}/${user.id}-${file.name}`;

    let { error } = await supabase.storage
      .from("ExamPortal")
      .upload(filePath, file, {
        cacheControl: "3600",
        upsert: false
      });

    if (error) {
      alert("Upload failed: " + error.message);
    } else {
      alert("Upload successful!");

      // Send confirmation email
      emailjs.send("YOUR_SERVICE_ID", "YOUR_TEMPLATE_ID", {
        to_email: user.email,
        subject: "Exam Paper Uploaded",
        message: `Dear ${user.email},\n\nYour exam paper has been successfully uploaded.\n\nClass: ${year}\nSubject: ${subject}\nFile: ${file.name}\n\nThank you,\nChindamanee School`
      })
      .then(() => {
        console.log("Confirmation email sent!");
      })
      .catch((err) => {
        console.error("Email send failed:", err);
      });

      // Refresh uploads list
      loadMyUploads();
    }
  }

  async function loadMyUploads() {
    const user = supabase.auth.user();
    if (!user) return;

    let { data, error } = await supabase
      .storage
      .from("ExamPortal")
      .list("", { limit: 100, offset: 0 });

    if (error) {
      console.error("Error loading files:", error);
      return;
    }

    const uploadList = document.getElementById("upload-list");
    uploadList.innerHTML = "";

    // Filter to only this user's files
    data.forEach(async (item) => {
      if (item.name.includes(user.id)) {
        const { publicURL } = supabase.storage.from("ExamPortal").getPublicUrl(item.name);
        const li = document.createElement("li");
        li.textContent = item.name;
        const link = document.createElement("a");
        link.href = publicURL;
        link.target = "_blank";
        link.textContent = "Download";
        li.appendChild(link);
        uploadList.appendChild(li);
      }
    });
  }
</script>

</body>
</html>
