<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Chindamanee School â€” Exam Portal</title>

  <style>
    :root{
      --primary:#222c65;
      --card:#f8faff;
      --bg:#f3f6f9;
    }

    body{
      font-family:system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;
      margin:0;
      background: var(--bg);
      color:#111;
      overflow-x: hidden;
      position: relative;
    }

    /* Floating welcome banner */
    .welcome-banner{
      position: fixed;
      top: 10px;
      left: 50%;
      transform: translateX(-50%) translateY(-50%);
      background: var(--primary);
      color: #fff;
      padding: 12px 20px;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 500;
      opacity: 0;
      animation: slideIn 1.2s ease-out forwards, wave 3s ease-in-out infinite alternate;
      z-index: 9999;
      text-align: center;
      max-width: 90%;
    }

    @keyframes slideIn{
      0%{opacity:0; transform: translateX(-50%) translateY(-50%);}
      100%{opacity:1; transform: translateX(-50%) translateY(0);}
    }

    @keyframes wave{
      0%{transform: translateX(-50%) translateY(0);}
      50%{transform: translateX(-50%) translateY(-5px);}
      100%{transform: translateX(-50%) translateY(0);}
    }

    /* Header with school color */
    header{
      display:flex;
      gap:12px;
      align-items:center;
      padding:20px;
      max-width:960px;
      margin:18px auto;
      background-color: var(--primary);
      color: #fff;
      border-radius: 12px;
      flex-wrap: wrap;
      position: relative;
      z-index: 2;
    }

    header h1, header .muted { color:#fff; margin:0; }
    img.logo { width:86px; height:auto; border-radius:8px; background:#fff; padding:4px; }

    .container{max-width:960px;margin:0 auto;padding:12px; position: relative; z-index: 2;}

    .card{
      background: var(--card);
      border-radius:12px;
      padding:18px;
      box-shadow:0 6px 18px rgba(20,30,40,0.06);
      margin-bottom:14px;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .card:hover{ transform: translateY(-5px); box-shadow:0 12px 24px rgba(20,30,40,0.12); }

    label{display:block;margin-top:10px;font-size:13px;color:#333}
    input[type="text"],input[type="email"],input[type="password"],select{
      width:100%;
      padding:9px;
      border:1px solid #ddd;
      border-radius:8px;
      margin-top:6px;
      box-sizing:border-box;
    }
    input[type="file"]{margin-top:8px}

    button{
      background:var(--primary);
      color:#fff;
      border:none;
      padding:10px 12px;
      border-radius:8px;
      cursor:pointer;
      margin-top:12px;
      transition: background 0.3s ease, transform 0.2s ease;
    }
    button:hover{ background:#1b2455; transform: translateY(-2px); }

    .muted{color:#666;font-size:13px}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .small{max-width:260px; flex: 1;}
    ul.file-list{list-style:none;padding-left:0;margin-top:10px}
    ul.file-list li{padding:8px 6px;border-bottom:1px solid #f0f0f0;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;}
    a.link{color:var(--primary);text-decoration:none}
    .right{margin-left:auto}
    .topbar{display:flex;gap:12px;align-items:center;justify-content:flex-end; flex-wrap: wrap;}

    @media (max-width: 768px){
      header{flex-direction: column; align-items: flex-start;}
      .row{flex-direction: column;}
      .small{max-width: 100%;}
      .topbar{justify-content: flex-start;}
      ul.file-list li{flex-direction: column; align-items: flex-start;}
      ul.file-list li div{margin-top:6px;}
    }

    /* Background shapes */
    .bg-shape{
      position: absolute;
      border-radius: 50%;
      opacity: 0.15;
      pointer-events: none;
      will-change: transform;
      transition: transform 0.05s linear;
    }

  </style>
</head>
<body>
  <!-- Floating welcome banner -->
  <div class="welcome-banner">ðŸ‘‹ Welcome Chindamanee Teachers! Please Sign up or Sign in before uploading exam paper.</div>

  <!-- Animated background shapes -->
  <div class="bg-shape" style="width:200px;height:200px;top:10%;left:5%;background:#222c65;"></div>
  <div class="bg-shape" style="width:150px;height:150px;top:70%;left:80%;background:#1769aa;"></div>
  <div class="bg-shape" style="width:100px;height:100px;top:40%;left:50%;background:#1b2455;"></div>
  <div class="bg-shape" style="width:180px;height:180px;top:20%;left:75%;background:#3a4a8f;"></div>
  <div class="bg-shape" style="width:130px;height:130px;top:60%;left:20%;background:#4b5f9e;"></div>

  <header>
    <img src="logo.png" alt="Chindamanee Logo" class="logo" onerror="this.style.display='none'">
    <div>
      <h1>Chindamanee School â€” Exam Portal</h1>
      <div class="muted">Teachers upload â†’ Admin downloads & prints</div>
    </div>
  </header>

  <div class="container">
    <!-- AUTH -->
    <div class="card" id="auth-card">
      <h3>Teacher Sign in / Sign up</h3>
      <label>Email</label>
      <input id="email" type="email" placeholder="name@chindamanee.ac.th" />
      <label>Password</label>
      <input id="password" type="password" placeholder="Choose a password (min 6 chars)" />
      <div class="row" style="margin-top:10px">
        <div class="small">
          <button onclick="signUp()">Sign up (teacher)</button>
        </div>
        <div class="small">
          <button onclick="signIn()">Sign in</button>
        </div>
      </div>
      <div style="margin-top:8px" class="muted">
        Only <strong>@chindamanee.ac.th</strong> emails are accepted by this page.
      </div>
    </div>

    <!-- SESSION INFO + Sign Out -->
    <div class="card" id="session-card" style="display:none">
      <div style="display:flex;align-items:center;gap:12px">
        <div>
          <strong id="user-email">--</strong><br>
          <span class="muted" id="user-id">UID: --</span>
        </div>
        <div class="topbar right">
          <button onclick="signOut()">Sign out</button>
        </div>
      </div>
    </div>

    <!-- UPLOAD -->
    <div class="card" id="upload-card" style="display:none">
      <h3>Upload Exam Paper</h3>
      <label>Class / Year</label>
      <select id="year">
        <option>Year 7</option><option>Year 8</option><option>Year 9</option>
        <option>Year 10</option><option>Year 11</option><option>Year 12</option><option>Year 13</option>
      </select>

      <label>Subject</label>
      <input id="subject" type="text" placeholder="e.g., Mathematics, English" />

      <label>Choose file (PDF, DOC, DOCX allowed)</label>
      <input id="file" type="file" accept=".pdf,.doc,.docx,application/msword,application/vnd.openxmlformats-officedocument.wordprocessingml.document" />

      <button onclick="uploadFile()">Upload to Supabase</button>
      <div id="upload-status" class="muted" style="margin-top:10px"></div>
    </div>

    <!-- ADMIN SECTION -->
    <div class="card" id="admin-card" style="display:none">
      <h3>Admin â€” Files list & download</h3>
      <div style="display:flex;gap:8px;align-items:center">
        <button onclick="listFiles()">Refresh list</button>
        <div class="muted" style="margin-left:auto">Bucket: <strong>ExamPortal</strong></div>
      </div>
      <ul id="file-list" class="file-list"></ul>
      <div class="muted" style="margin-top:8px">If downloads fail, make the bucket public in Supabase Storage settings.</div>
    </div>

    <div style="margin-top:8px;font-size:13px;color:#666">
      For assistance please contact ICT department. Thank you teacher.
    </div>
  </div>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'
    const SUPABASE_URL = 'https://vydaeemptmxxixwwoepj.supabase.co';
    const SUPABASE_ANON_KEY = 'YOUR_SUPABASE_ANON_KEY';
    const BUCKET = 'ExamPortal';
    const ADMINS = ['admin@chindamanee.ac.th','principal@chindamanee.ac.th'];
    const supabase = createClient(SUPABASE_URL,SUPABASE_ANON_KEY);

    const authCard=document.getElementById('auth-card');
    const uploadCard=document.getElementById('upload-card');
    const adminCard=document.getElementById('admin-card');
    const sessionCard=document.getElementById('session-card');
    const userEmailEl=document.getElementById('user-email');
    const userIdEl=document.getElementById('user-id');
    const uploadStatusEl=document.getElementById('upload-status');
    const fileListEl=document.getElementById('file-list');
    const bgShapes = document.querySelectorAll('.bg-shape');
    const welcomeBanner = document.querySelector('.welcome-banner');
    let currentUser=null;

    (async function init(){
      const { data }=await supabase.auth.getSession();
      currentUser=data?.session?.user??null;
      updateUI();
      supabase.auth.onAuthStateChange((_event,session)=>{
        currentUser=session?.user??null;
        updateUI();
      });
      // Fade out welcome banner after 5 seconds
      setTimeout(()=>{welcomeBanner.style.transition='opacity 1s ease'; welcomeBanner.style.opacity='0';},5000);
    })();

    // Background shapes float randomly
    document.addEventListener('mousemove', e => {
      const x = e.clientX / window.innerWidth - 0.5;
      const y = e.clientY / window.innerHeight - 0.5;
      bgShapes.forEach((shape, i) => {
        const speed = (i+1)*10;
        const scale = 1 + Math.sin(Date.now()/1000 + i) * 0.05;
        const rotate = (Date.now()/50 + i*30) % 360;
        shape.style.transform = `translate(${x*speed}px, ${y*speed}px) scale(${scale}) rotate(${rotate}deg)`;
      });
    });

    function validateSchoolEmail(email){return typeof email==='string' && email.toLowerCase().endsWith('@chindamanee.ac.th');}
    async function signUp(){const email=document.getElementById('email').value.trim(); const password=document.getElementById('password').value;
      if(!validateSchoolEmail(email)) return alert('Only @chindamanee.ac.th emails are allowed.');
      if(!password || password.length<6) return alert('Password must be at least 6 characters.');
      try{const { error }=await supabase.auth.signUp({email,password}); if(error) throw error; alert('Signup successful â€” check your email for a confirmation link.');}catch(err){alert('Sign up error: '+(err.message||err));}
    }
    async function signIn(){const email=document.getElementById('email').value.trim(); const password=document.getElementById('password').value;
      if(!validateSchoolEmail(email)) return alert('Only @chindamanee.ac.th emails are allowed.');
      if(!password) return alert('Enter your password.');
      try{const { error }=await supabase.auth.signInWithPassword({email,password}); if(error) throw error;}catch(err){alert('Sign in error: '+(err.message||err));}
    }
    async function signOut(){await supabase.auth.signOut(); currentUser=null; updateUI();}

    function updateUI(){
      if(currentUser){
        authCard.style.display='none'; uploadCard.style.display='block'; sessionCard.style.display='block';
        userEmailEl.textContent=currentUser.email; userIdEl.textContent=`UID: ${currentUser.id}`;
        adminCard.style.display=ADMINS.includes(currentUser.email.toLowerCase())?'block':'none';
      }else{
        authCard.style.display='block'; uploadCard.style.display='none'; adminCard.style.display='none'; sessionCard.style.display='none';
        userEmailEl.textContent='--'; userIdEl.textContent='UID: --';
      }
    }

    function sanitizeForFilename(s){return (s||'unknown').replace(/\s+/g,'_').replace(/[^\w\-.]/g,'');}
    async function uploadFile(){
      if(!currentUser) return alert('Please sign in first.');
      const year=document.getElementById('year').value;
      const subject=document.getElementById('subject').value.trim();
      const fileInput=document.getElementById('file'); const file=fileInput.files[0];
      if(!file) return alert('Select a file to upload.');
      const allowed=['pdf','doc','docx']; const ext=(file.name.split('.').pop()||'').toLowerCase();
      if(!allowed.includes(ext)){if(!confirm('Allowed: pdf, doc, docx. Do you still want to upload?')) return;}
      uploadStatusEl.textContent='Uploadingâ€¦ please wait';
      const safeSubject=sanitizeForFilename(subject||'Subject');
      const safeFilename=`${Date.now()}__${sanitizeForFilename(file.name)}`;
      const path=`${sanitizeForFilename(year)}__${safeSubject}__${safeFilename}`;
      try{const { error }=await supabase.storage.from(BUCKET).upload(path,file,{upsert:false}); if(error) throw error;
        uploadStatusEl.textContent='Upload successful âœ”'; fileInput.value=''; document.getElementById('subject').value='';
      }catch(err){uploadStatusEl.textContent=''; alert('Upload failed: '+(err.message||err));}
    }

    async function listFiles(){
      fileListEl.innerHTML='<li class="muted">Loadingâ€¦</li>';
      try{
        const { data, error }=await supabase.storage.from(BUCKET).list('',{limit:200});
        if(error) throw error; if(!data || data.length===0){fileListEl.innerHTML='<li class="muted">No files found</li>'; return;}
        fileListEl.innerHTML='';
        data.forEach(f=>{
          const li=document.createElement('li'); const nameSpan=document.createElement('span'); nameSpan.textContent=f.name; li.appendChild(nameSpan);
          const btns=document.createElement('div');
          const publicRes=supabase.storage.from(BUCKET).getPublicUrl(f.name); const publicUrl=publicRes?.data?.publicUrl||null;
          const a=document.createElement('a'); a.href=publicUrl||'#'; a.target='_blank'; a.className='link'; a.textContent='Download';
          a.onclick=(ev)=>{if(!publicUrl){ev.preventDefault(); alert('No public URL: make the bucket public in Supabase Storage settings.');}}; btns.appendChild(a);
          const rm=document.createElement('button'); rm.style.marginLeft='8px'; rm.textContent='Delete'; rm.onclick=async()=>{if(!confirm('Delete file permanently?')) return; const { error }=await supabase.storage.from(BUCKET).remove([f.name]); if(error) return alert('Delete error: '+error.message); listFiles();}; btns.appendChild(rm);
          li.appendChild(btns); fileListEl.appendChild(li);
        });
      }catch(err){fileListEl.innerHTML=''; alert('List files error: '+(err.message||err));}
    }

    window.signUp=signUp; window.signIn=signIn; window.signOut=signOut; window.uploadFile=uploadFile; window.listFiles=listFiles;
  </script>
</body>
</html>
